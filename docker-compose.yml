services:
  line-nextcloud-bot:
    build: .
    container_name: line-nextcloud-bot
    restart: unless-stopped
    # Run as host user so ./data is writable without chown (set UID/GID in .env from: id -u, id -g)
    user: "${UID:-1000}:${GID:-1000}"
    ports:
      - "8000:8000"
    environment:
      - TZ=Asia/Taipei
      - LINE_CHANNEL_SECRET=${LINE_CHANNEL_SECRET}
      - LINE_CHANNEL_ACCESS_TOKEN=${LINE_CHANNEL_ACCESS_TOKEN}
      - NEXTCLOUD_URL=${NEXTCLOUD_URL}
      - NEXTCLOUD_USER=${NEXTCLOUD_USER}
      - NEXTCLOUD_PASSWORD=${NEXTCLOUD_PASSWORD}
      - NEXTCLOUD_BASE_PATH=${NEXTCLOUD_BASE_PATH:-LINE_Backup}
      - ENABLE_LINE_REPLIES=${ENABLE_LINE_REPLIES:-false}
      - SOURCE_MAP=${SOURCE_MAP:-}
      - SOURCE_MAP_FILE=${SOURCE_MAP_FILE:-data/source_map.json}
      - SOURCE_STATE_FILE=${SOURCE_STATE_FILE:-}
      - MAX_FILE_SIZE_MB=${MAX_FILE_SIZE_MB:-0}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-}
      - GITHUB_REPO=${GITHUB_REPO:-}
    env_file:
      - .env
    volumes:
      # Persist source state (SOURCE_STATE_FILE=data/source_state.json) across restarts
      - ./data:/app/data
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 2
      start_period: 10s
